{% extends 'ideas/base.html' %}
{% load humanize %}
{% block title %}{{ idea.title }} - Innovation Tracker{% endblock %}
{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card shadow mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h2 class="card-title mb-1">{{ idea.title }}</h2>
            <p class="text-muted mb-0">
              Submitted by <strong>{{ idea.submitter.username }}</strong> on
              {{ idea.submission_date|date:"M j, Y" }} Â· Status:
              <span class="text-capitalize">{{ idea.get_status_display }}</span>
            </p>
          </div>
          {% if idea.category %}
          <span class="badge badge-category align-self-start">{{ idea.category.name }}</span>
          {% endif %}
        </div>
        <p class="lead">{{ idea.description }}</p>
        {% if user == idea.submitter %}
        <a href="{% url 'edit_idea' idea.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-pencil"></i> Edit Idea
        </a>
        {% endif %}
      </div>
      <div class="card-footer d-flex gap-3 align-items-center">
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'vote' idea.pk %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="vote_type" value="upvote" />
          <button class="btn btn-outline-success vote-btn {% if user_vote and user_vote.vote_type == 'upvote' %}active{% endif %}">
            <i class="bi bi-hand-thumbs-up"></i> {{ idea.upvote_count }}
          </button>
        </form>
        <form method="post" action="{% url 'vote' idea.pk %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="vote_type" value="downvote" />
          <button class="btn btn-outline-danger vote-btn {% if user_vote and user_vote.vote_type == 'downvote' %}active{% endif %}">
            <i class="bi bi-hand-thumbs-down"></i> {{ idea.downvote_count }}
          </button>
        </form>
        {% else %}
        <p class="mb-0 text-muted">Login to vote and comment.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow">
      <div class="card-header bg-white">
        <h4 class="mb-0"><i class="bi bi-chat-dots"></i> Comments ({{ idea.comment_count }})</h4>
      </div>
      <div class="card-body">
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' idea.pk %}" class="mb-4">
          {% csrf_token %}
          {{ comment_form.content }}
          <button class="btn btn-primary mt-2">Add Comment</button>
        </form>
        {% else %}
        <p class="text-muted">Please <a href="{% url 'login' %}">login</a> to add a comment.</p>
        {% endif %}

        {% if comments %}
        <ul class="list-unstyled">
          {% for comment in comments %}
          <li class="mb-4">
            <div class="border rounded p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>{{ comment.user.username }}</strong>
                <small class="text-muted">{{ comment.timestamp|naturaltime }}</small>
              </div>
              <p class="mb-2">{{ comment.content }}</p>
              {% if user.is_authenticated %}
              <button class="btn btn-link btn-sm" data-bs-toggle="collapse" data-bs-target="#reply-{{ comment.pk }}">Reply</button>
              <form method="post" action="{% url 'add_comment' idea.pk %}" class="collapse" id="reply-{{ comment.pk }}">
                {% csrf_token %}
                <input type="hidden" name="parent_id" value="{{ comment.pk }}" />
                <textarea name="content" class="form-control" rows="2" placeholder="Write a reply..."></textarea>
                <button class="btn btn-outline-primary btn-sm mt-2">Post Reply</button>
              </form>
              {% endif %}
            </div>
            {% if comment.replies.exists %}
            <ul class="list-unstyled ms-4 mt-3">
              {% for reply in comment.replies.all %}
              <li class="mb-3">
                <div class="border-start ps-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong>{{ reply.user.username }}</strong>
                    <small class="text-muted">{{ reply.timestamp|naturaltime }}</small>
                  </div>
                  <p class="mb-0">{{ reply.content }}</p>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">No comments yet. Start the conversation!</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow">
      <div class="card-header bg-white">
        <h4 class="mb-0"><i class="bi bi-bar-chart"></i> Idea Stats</h4>
      </div>
      <div class="card-body">
        <p class="mb-2"><strong>Score:</strong> {{ idea.vote_score }}</p>
        <p class="mb-2"><strong>Upvotes:</strong> {{ idea.upvote_count }}</p>
        <p class="mb-2"><strong>Downvotes:</strong> {{ idea.downvote_count }}</p>
        <p class="mb-2"><strong>Total Comments:</strong> {{ idea.comment_count }}</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

